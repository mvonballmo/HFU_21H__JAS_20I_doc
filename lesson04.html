<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>JavaScript, Lektion 04, Externe Abfrage: JSON &amp; Fetch</title>

  <link rel="stylesheet" href="dist/reset.css">
  <link rel="stylesheet" href="dist/reveal.css">
  <link rel="stylesheet" href="dist/theme/white.css">
  <link rel="stylesheet" href="slides.css">

  <!-- Theme used for syntax highlighted code -->
  <link rel="stylesheet" href="plugin/highlight/github.css">
</head>

<body>
  <div class="reveal">
    <div class="slides">
      <section data-background="assets/MonteRosa.jpg">
        <h1>JavaScript</h1>
        <h2>Lektion 4</h2>
        <p class="notes">
          Ein Angebot der Berufsfachschule Uster und der Höheren Fachschule Uster
        </p>
      </section>

      <section data-background="assets/looking-back-dimmed.jpg">
        <h1>Rückblick</h1>
        <ul>
          <li>Grundlagen:
            <ul>
              <li><a href="https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Functions">Funktionen</a></li>
              <li><a href="https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Classes">Klassen</a></li>
              <li><a href="https://developer.mozilla.org/de/docs/Web/JavaScript/Guide/Modules">Modulen</a></li>
            </ul>
          </li>
          <li><a href="https://prettier.io/">Prettier</a> &amp; <a href="https://eslint.org/">ESLint</a></li>
          <li><a href="https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Global_Objects/JSON">JSON</a></li>
          <li><a href="https://developer.mozilla.org/de/docs/Web/API/Fetch_API"><code>fetch()</code></a>, <code>async</code>/<code>await</code></li>
        </ul>
      </section>

      <section>
        <h1>Übersicht Lektionen</h1>
        <ol class="compact">
          <li class="completed">Einführung &amp; IDE Aufsetzen</li>
          <li class="completed">Grundlagen: Typen, Operatoren, Statements, usw.</li>
          <li class="completed">Grundlagen: Funktionen, Klassen, Modulen</li>
          <li class="selected">Externe Abfrage (JSON &amp; Fetch)</li>
          <li>DOM, Formulare, Eingaben &amp; Ereignisse</li>
          <li>Persistenz (Cookies, Web storage &amp; IndexedDB)</li>
          <li>Komponenten (Web Components) &amp; Bibliotheken</li>
          <li><b>LZ1</b>; Animationen &amp; Grafik</li>
          <li>React (manipulation, aktualisierung)</li>
          <li><b>MLZ Präsentationen</b></li>
        </ol>
      </section>

      <section data-background="assets/macro-focus-cogwheel-gear-159275-dimmed.jpg">
        <h1>JSON &amp; Fetch</h1>
        <p>Hier geht es um Daten mit anderen Systemen auszutauschen.</p>
        <ul>
          <li><a href="https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Global_Objects/JSON">JSON</a>: standardisiertes Austauschformat</li>
          <li><a href="https://developer.mozilla.org/de/docs/Web/API/Fetch_API">Fetch</a>: Kommunikations-API</li>
        </ul>
      </section>

      <section>
        <h1>JSON: Einführung</h1>
        <ul>
          <li>Akronym für "JavaScript Object Notation"</li>
          <li>Unterstützt mittlerweile überall</li>
          <li>Repräsentiert JavaScript Strukturen, inklusive:
            <ul>
              <li>Objekte <code>{}</code></li>
              <li>Arrays <code>[]</code></li>
              <li>Felder (Null, Undefined, Strings, Numbers, Booleans)</li>
            </ul>
          </li>
        </ul>
      </section>

      <section>
        <h1>JSON: Einschränkungen</h1>
        <ul>
          <li><code>NaN</code> wird zu <code>null</code></li>
          <li><code>Date</code> wird zu <code>String</code></li>
          <li><code>Function</code>, <code>RegExp</code> und <code>Error</code> Objekte werden nicht nach JSON übertragen.</li>
        </ul>
      </section>

      <section>
        <h1>JSON: Beispiel</h1>
        <p>Sieht aus wie JavaScript ausserdem Eigenschafts&shy;namen werden mit Strings geschrieben.</p>
        <pre>
          <code data-trim class="language-javascript hljs">
            {
              "firstName": "John",
              "lastName": "Doe",
              "age": 42,
              "active": true
              "cars": [
                { "make": "VW", "model": "Golf" },
                { "make": "BMW", "model": "M3" }
              ]
            }
          </code>
        </pre>
      </section>

      <section>
        <h1>JSON: Lesen/Schreiben</h1>
        <li><a href="https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse"><code>JSON.parse()</code></a> wandelt JSON in JS um</li>
        <li><a href="https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify"><code>JSON.stringify()</code></a> wandelt JS in JSON um</li>
        <pre>
          <code data-trim class="language-javascript hljs">
            const obj = { color: "red", speed: 50.2 };

            const json = JSON.stringify(obj);
            // json == '{"color":"red","speed":50.2}'

            const obj2 = JSON.parse(json);
            // obj === obj2
          </code>
        </pre>
      </section>

      <section>
        <h1><a href="https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify"><code>JSON.stringify()</code></a></h1>
        <p>Das Ausgabeformat kann mit optionalen Parametern angepasst werden.</p>
        <pre>
          <code data-trim class="language-javascript hljs">
            const isString = v => typeof v === "string"
            const replacer = (k, v) => isString(v) ? undefined : v;
            const obj = { color: "red", speed: 50.2 };
            const json = JSON.stringify(obj, replacer);
            // json == '{"speed":50.2}'
            const json2 = JSON.stringify(obj, replacer, /* space: */ 2);
            /* json2 == `{
              "speed": 50.2
            }`*/
          </code>
        </pre>
      </section>

      <section>
        <h1><a href="https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify"><code>toJSON()</code></a></h1>
        <p>Zu exportierenden Objekten können das Ausgabe&shy;format mit einer <code>toJSON()</code> Methode selbst steuern.</p>
        <pre>
          <code data-trim class="language-javascript hljs">
            const obj = {
              password: "password123",
              speed: 50.2,
              toJSON(key) {
                const { password, ...rest } = this;
                return rest;  // without "password"
              }
            };
            const json = JSON.stringify(obj);
            // json == '{"speed":50.2}'
          </code>
        </pre>
      </section>

      <section>
        <div class="seventy-thirty-grid">
          <div>
            <h1>JSON</h1>
            <ul>
              <li><code>JSON.stringify()</code>
                <ul>
                  <li>Mit Formatierung</li>
                  <li>Mit <code>toJSON()</code></li>
                </ul>
              </li>
              <li><code>JSON.parse()</code></li>
            </ul>
          </div>
          <img src="assets/demo.png">
        </div>
      </section>

      <section>
        <h1>Fragen?</h1>
        <div class="fifty-fifty-grid">
          <img src="assets/okaaaay.jpg">
        </div>
      </section>

      <section>
        <div class="seventy-thirty-grid">
          <div>
            <h1>Übungen</h1>
            <ul>
              <li>Test mit JSON.stringify() schreiben</li>
              <li>Test mit JSON.parse() schreiben</li>
            </ul>
          </div>
          <img src="assets/cog-wheels.png">
        </div>
      </section>

      <section data-background="assets/macro-focus-cogwheel-gear-159275-dimmed.jpg">
        <h1><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model"><code>fetch()</code></a></h1>
        <p>Hier geht es um Daten mit einem Server auszutauschen.</p>
        <ul>
          <li><code>json-server</code> aufsetzen</li>
          <li>Promises</li>
          <li><code>async</code>/<code>await</code></li>
          <li><code>GET</code></li>
          <li><code>POST</code></li>
          <li><code>DELETE</code></li>
        </ul>
      </section>

      <section class="compact">
        <h1><code>json-server</code> aufsetzen</h1>
        <ul>
          <li><code>npm install --save-dev json-server</code> ausführen</li>
          <li>JSON-Datei (z.B. <code>./data.json</code>) mit Daten füllen</li>
        </ul>
        <pre>
          <code data-trim class="language-javascript hljs">
            {
              "addresses": [
                { "name": "Maria" },
                { "name": "Johann" }
              ]
            }
          </code>
        </pre>
        <ul>
          <li><code>json-server ./data.json</code> ausführen</li>
          <li>Nach <a href="http://localhost:3000">http://localhost:3000</a> im Browser navigieren</li>
        </ul>
      </section>

      <section>
        <h1>Promises</h1>
        <p>Platzhalter für einen asynchronen Funktionsaufruf</p>
        <table>
          <tr>
            <td><code>then()</code></td>
            <td>wird beim <span class="fragment highlight-green">erfolgreichen</span> Ausführen der Funktion ausgeführt</td>
          </tr>
          <tr>
            <td><code>catch()</code></td>
            <td>wird beim <span class="fragment highlight-red">fehlgeschlagenen</span> Ausführen der Funktion ausgeführt</td>
          </tr>
          <tr>
            <td><code>finally()</code></td>
            <td>wird <span class="fragment highlight-blue">immer</span> ausgeführt</td>
          </tr>
        </table>
      </section>

      <section>
        <h1><code>fetch()</code>: Daten holen</h1>
        <ul>
          <li>Gibt zwei verschachtelten <code>Promises</code> zurück</li>
          <li>URL an <code>fetch()</code> mitgeben</li>
          <li>Wenn erfolgreich, denn von JSON nach <em>Adressen</em> mit <code>json()</code> umwandeln lassen</li>
          <li>Wenn erfolgreich, denn mit den <em>Adressen</em> arbeiten</li>
        </ul>
        <pre>
          <code data-trim class="language-javascript hljs">
            fetch("http://localhost:3000/addresses")
              .then(data => data.json())
              .then(addresses => {
                // mit "addresses" arbeiten
              });
          </code>
        </pre>
      </section>

      <section>
        <h1><code>fetch()</code> testen</h1>
        <ul>
          <li>Bei <em>node</em> gibt es kein <code>fetch</code></li>
          <li><code>npm install --save-dev isomorphic-fetch</code> ausführen, um <code>fetch</code> für <em>node</em> zu installieren</li>
        </ul>
      </section>

      <section>
        <h1><code>fetch()</code> testen II</h1>
        <ul>
          <li>Das <code>Promise</code> muss man mit <code>return</code> zurückgeben</li>
        </ul>
        <pre>
          <code data-trim class="language-javascript hljs">
            import "isomorphic-fetch";  // Oben in die Datei

            test("call fetch gets addresses", () => {
              return fetch("http://localhost:3000/addresses")
                .then(data => data.json())
                .then(addresses => {
                  expect(addresses.length).toBe(12);
                });
            });
          </code>
        </pre>
        <p class="notes">Siehe <a href="https://jestjs.io/docs/asynchronous">Testing Asynchronous Code</a> für mehr Information.</p>
      </section>

      <section>
        <h1><code>async</code>/<code>await</code></h1>
        <ul>
          <li>Verschachtelte Aufrufe sind nicht besonders lesbar oder nachvollziehbar</li>
          <li>Stattdessen kann man ein <code>Promise</code> mit <code>await</code> "abwarten"</li>
          <li>Funktionen, die zumindest ein <code>await</code> beinhalten müssen mit <code>async</code> bezeichnet werden</li>
        </ul>
      </section>

      <section>
        <h1>Test mit <code>async</code>/<code>await</code></h1>
        <ul>
          <li>Die zwei <code>Promises</code> sind klarer zu sehen</li>
          <li><code>expect()</code> funktioniert wie erwartet (ohne ein <code>Promise</code> aus dem inneren Kontext zurückgeben zu müssen</li>
        </ul>
        <pre>
          <code data-trim class="language-javascript hljs">
            test("call fetch with async/await", async () => {
              const promise = await fetch("http://localhost:3000/addresses");
              const addresses = await promise.json();

              expect(addresses.length).toBe(12);
            });
          </code>
        </pre>
      </section>

      <section>
        <h1 class="insertion">Exception-Handling</h1>
        <table>
          <tr>
            <td><code>try {}</code></td>
            <td>wird bis einen <span class="fragment highlight-red">Fehler</span> vorkommt ausgeführt</td>
          </tr>
          <tr>
            <td><code>catch()</code></td>
            <td>wird nur bei einem <span class="fragment highlight-red">Fehler im <code>try {}</code></span> ausgeführt</td>
          </tr>
          <tr>
            <td><code>finally()</code></td>
            <td>wird <span class="fragment highlight-blue">immer</span> ausgeführt</td>
          </tr>
        </table>
      </section>

      <section>
        <h1><code>Promises</code> mit Fehlern</h1>
        <p>Die <code>catch()</code> und <code>finally()</code> Methoden eines <code>Promises</code> werden mit Exception-Handling ersetzt</p>
        <pre>
          <code data-trim class="language-javascript hljs">
            async function getAddresses() {
              try {
                const promise = await fetch("http://localhost:3000/addresses");
                return await promise.json();
              } catch(error) {
                console.log(error);
              } finally {
                // Wird immer ausgeführt (cleanup, logging, usw.)
              }
            }
        </code>
        </pre>
      </section>

      <section>
        <h1>Mehrere <code>Promises</code></h1>
        <p>Mit <code>Promise.All()</code> kann auf mehrere asynchrone Aufrufe gewartet werden.</p>
        <pre>
          <code data-trim class="language-javascript hljs">
            test("wait for multiple fetch calls", async () => {
              const addressPromise = getAddresses();
              const carPromise = getCars();

              const [addresses, cars] = await Promise.all([addressPromise, carPromise]);

              expect(addresses.length).toBe(12);
              expect(cars.length).toBe(2);
            });
          </code>
        </pre>
      </section>

      <section>
        <h1><code>fetch()</code> mit <code>POST</code></h1>
        <ul>
          <li>Einen neuen Eintrag kann mit der Methode <code>POST</code> erstellt werden</li>
          <li>Der <code>Content-Type</code> Header muss gesetzt werden</li>
          <li>Das <code>body</code> muss als JSON gesetzt werden</li>
        </ul>
        <pre>
          <code data-trim class="language-javascript hljs">
            await fetch(`http://localhost:3000/addresses/`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(address),
            });
          </code>
        </pre>
      </section>

      <section>
        <h1><code>json-server</code>: ID</h1>
        <ul>
          <li>Um Entitäten aktualisieren oder löschen zu können muss man einen <code>ID</code> zuweisen</li>
          <li>Beim erstellen einer Entität wird ein <code>ID</code> automatisch zugewiesen</li>
          <li>Eine Adresse mit <code>ID == 1</code> holen: http://localhost:3000/addresses/1</li>
        </ul>
      </section>

      <section>
        <h1><code>fetch()</code> mit <code>PUT</code></h1>
        <ul>
          <li>Einen bestehenden Eintrag kann mit der Methode <code>PUT</code> angepasst werden</li>
          <li>Der <code>Content-Type</code> Header muss gesetzt werden</li>
          <li>Das <code>body</code> muss als JSON gesetzt werden</li>
          <li>Mit dieser Methode muss man ein <code>ID</code> mitgeben</li>
        </ul>
        <pre>
          <code data-trim class="language-javascript hljs">
            await fetch(`http://localhost:3000/addresses/`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(address),
            });
          </code>
        </pre>
      </section>

      <section>
        <h1><code>fetch()</code> mit <code>DELETE</code></h1>
        <ul>
          <li>Einen Eintrag kann mit der Methode <code>DELETE</code> gelöscht werden</li>
          <li>Mit dieser Methode muss man ein <code>ID</code> mitgeben</li>
        </ul>
        <pre>
          <code data-trim class="language-javascript hljs">
            await fetch(`http://localhost:3000/addresses/1`, {
              method: "DELETE" }
            );
          </code>
        </pre>
      </section>

      <section>
        <h1><code>json-server</code> mit "watch"</h1>
        <ul>
          <li>Änderungen an die lokale Datei (z.B. bei einem "Revert" in Git) werden von <code>json-server</code> nicht wahrgenommen</li>
          <li>Mit der <code>--watch</code> Option lädt sich <code>json-server</code> bei Änderungen neu</li>
          <li><code>json-server ./data.json --watch</code> ausführen</li>
        </ul>
      </section>

      <section>
        <h1><code>fetch()</code>: Response</h1>
        <ul>
          <li>Bei gravierendem Fehler kommt ein <code>Error</code></li>
          <li>Einen <code>404</code> Fehler ist nicht gravierend</li>
          <li>Response testen, ob der Resultat vorhanden ist</li>
        </ul>
        <pre>
          <code data-trim class="language-javascript hljs">
            const response = await fetch(`http://localhost:3000/addresses/1`);

            if (response.ok) {
              const address = await response.json();
            } else {
              // "response.statusCode"
              // "response.statusText"
            }
          </code>
        </pre>
      </section>

      <section>
        <div class="seventy-thirty-grid">
          <div>
            <h1><code>fetch()</code></h1>
            <ul>
              <li>Test mit <code>async</code>/<code>await</code></li>
              <li>Test für <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code></li>
            </ul>
          </div>
          <img src="assets/demo.png">
        </div>
      </section>

      <section>
        <h1>Fragen?</h1>
        <div class="fifty-fifty-grid">
          <img src="assets/okaaaay.jpg">
        </div>
      </section>

      <section>
        <div class="seventy-thirty-grid">
          <div>
            <h1>Übungen</h1>
            <ul>
              <li>Test für <code>GET</code> für alle Entitäten</li>
              <li>Test für <code>GET</code> für eine einzige Entität</li>
            </ul>
          </div>
          <img src="assets/cog-wheels.png">
        </div>
      </section>

      <section>
        <div class="seventy-thirty-grid">
          <div>
            <h1>Übungen</h1>
            <ul>
              <li>Test für <code>GET</code> für alle Entitäten</li>
              <li>Test für <code>GET</code> für eine einzige Entität</li>
            </ul>
          </div>
          <img src="assets/cog-wheels.png">
        </div>
      </section>

      <section>
        <h1 class="insertion">Refactoring</h1>
        <ul>

        </ul>
      </section>

    </div>
  </div>

  <script src="dist/reveal.js"></script>
  <script src="plugin/notes/notes.js"></script>
  <script src="plugin/markdown/markdown.js"></script>
  <script src="plugin/highlight/highlight.js"></script>
  <script>
    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
      hash: true,

      // Learn about plugins: https://revealjs.com/plugins/
      plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
    });
  </script>
</body>

</html>